{% extends "base.html" %}

{% block title %}Data Cleaning{% endblock %}

{% block content %}
<h1 class="main-header">Data Cleaning ðŸ§¹</h1>

<div class="bg-primary-custom">
    <h3>About Data Cleaning</h3>
    <p>Clean your dataset by handling missing values, removing duplicates, fixing data types, and more.</p>
</div>

<div class="row">
    <!-- Data Preview -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">Data Preview</h4>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <div id="data-preview-loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading data preview...</p>
                    </div>
                    <div id="data-preview" style="display: none;">
                        <div class="mb-3">
                            <strong>Dataset:</strong> <span id="filename"></span>
                            <strong class="ms-3">Rows:</strong> <span id="row-count"></span>
                            <strong class="ms-3">Columns:</strong> <span id="column-count"></span>
                        </div>
                        <table class="table table-striped table-hover">
                            <thead id="preview-thead">
                                <tr>
                                    <!-- Column headers will be inserted here -->
                                </tr>
                            </thead>
                            <tbody id="preview-tbody">
                                <!-- Data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="data-preview-error" class="alert alert-danger" style="display: none;">
                        Error loading data preview. Please upload a file or use the sample data.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cleaning Actions -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Cleaning Actions</h4>
            </div>
            <div class="card-body">
                <form id="cleaning-form">
                    <div class="mb-3">
                        <h5>Missing Values</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="drop_na" name="drop_na">
                            <label class="form-check-label" for="drop_na">
                                Drop rows with missing values
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fill_na_mean" name="fill_na_mean">
                            <label class="form-check-label" for="fill_na_mean">
                                Fill numeric missing values with mean
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fill_na_mode" name="fill_na_mode">
                            <label class="form-check-label" for="fill_na_mode">
                                Fill categorical missing values with mode
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Duplicates</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="drop_duplicates" name="drop_duplicates">
                            <label class="form-check-label" for="drop_duplicates">
                                Remove duplicate rows
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Outliers</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remove_outliers" name="remove_outliers">
                            <label class="form-check-label" for="remove_outliers">
                                Remove outliers (beyond 3 standard deviations)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Data Types</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convert_numeric" name="convert_numeric">
                            <label class="form-check-label" for="convert_numeric">
                                Convert likely numeric columns
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convert_datetime" name="convert_datetime">
                            <label class="form-check-label" for="convert_datetime">
                                Convert likely datetime columns
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" id="apply-cleaning" class="btn btn-primary w-100">Apply Cleaning</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Data Summary -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Data Summary</h4>
            </div>
            <div class="card-body">
                <div id="summary-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating data summary...</p>
                </div>
                <div id="summary-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Columns</h5>
                            <div id="column-summary" class="mb-3">
                                <!-- Column summary will be inserted here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Missing Values</h5>
                            <div id="missing-summary" class="mb-3">
                                <!-- Missing values summary will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Numeric Columns</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Mean</th>
                                    <th>Median</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Std Dev</th>
                                </tr>
                            </thead>
                            <tbody id="numeric-summary">
                                <!-- Numeric summary will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <h5>Categorical Columns</h5>
                        <div id="categorical-summary">
                            <!-- Categorical summary will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="summary-error" class="alert alert-danger" style="display: none;">
                    Error generating data summary. Please upload a file or use the sample data.
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">Cleaning Result</h4>
            </div>
            <div class="card-body">
                <div id="cleaning-result" style="display: none;">
                    <div class="mb-3">
                        <h5>Cleaning Summary</h5>
                        <ul id="cleaning-summary">
                            <!-- Cleaning summary will be inserted here -->
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h5>Download Cleaned Data</h5>
                        <button id="download-csv" class="btn btn-success me-2">Download CSV</button>
                        <button id="download-excel" class="btn btn-success">Download Excel</button>
                    </div>
                </div>
                <div id="cleaning-placeholder">
                    <p class="text-muted">Apply cleaning actions to see results.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load data preview on page load
    loadDataPreview();
    
    // Handle apply cleaning button
    document.getElementById('apply-cleaning').addEventListener('click', applyCleaningActions);
    
    // Handle download buttons
    document.getElementById('download-csv').addEventListener('click', function() {
        downloadCleanedData('csv');
    });
    
    document.getElementById('download-excel').addEventListener('click', function() {
        downloadCleanedData('excel');
    });
});

function loadDataPreview() {
    const previewLoading = document.getElementById('data-preview-loading');
    const previewContent = document.getElementById('data-preview');
    const previewError = document.getElementById('data-preview-error');
    
    previewLoading.style.display = 'block';
    previewContent.style.display = 'none';
    previewError.style.display = 'none';
    
    // Fetch data preview from API
    fetch('/api/data/preview')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load data preview');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update dataset info
            document.getElementById('filename').textContent = data.filename || 'Unknown';
            document.getElementById('row-count').textContent = data.data.length;
            document.getElementById('column-count').textContent = data.columns.length;
            
            // Populate column headers
            const thead = document.getElementById('preview-thead');
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            data.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Populate data rows (limit to first 10 rows)
            const tbody = document.getElementById('preview-tbody');
            tbody.innerHTML = '';
            data.data.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                data.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] !== null ? row[column] : 'NULL';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // Show the preview
            previewLoading.style.display = 'none';
            previewContent.style.display = 'block';
            
            // Generate data summary
            generateDataSummary(data);
        })
        .catch(error => {
            console.error('Error loading data preview:', error);
            previewLoading.style.display = 'none';
            previewError.style.display = 'block';
            previewError.textContent = error.message || 'Error loading data preview. Please upload a file or use the sample data.';
        });
}

function generateDataSummary(data) {
    const summaryLoading = document.getElementById('summary-loading');
    const summaryContent = document.getElementById('summary-content');
    const summaryError = document.getElementById('summary-error');
    
    summaryLoading.style.display = 'block';
    summaryContent.style.display = 'none';
    summaryError.style.display = 'none';
    
    try {
        // Column types summary
        const columnTypes = {};
        data.columns.forEach(column => {
            // Determine column type based on first non-null value
            const nonNullValue = data.data.find(row => row[column] !== null)?.[column];
            if (nonNullValue === undefined) {
                columnTypes[column] = 'unknown';
            } else if (!isNaN(nonNullValue) && typeof nonNullValue !== 'boolean') {
                columnTypes[column] = 'numeric';
            } else if (typeof nonNullValue === 'string' && 
                      (nonNullValue.match(/^\d{4}-\d{2}-\d{2}/) || 
                       nonNullValue.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/))) {
                columnTypes[column] = 'datetime';
            } else {
                columnTypes[column] = 'categorical';
            }
        });
        
        // Display column summary
        const columnSummary = document.getElementById('column-summary');
        columnSummary.innerHTML = `
            <p>Total Columns: ${data.columns.length}</p>
            <p>Numeric Columns: ${Object.values(columnTypes).filter(t => t === 'numeric').length}</p>
            <p>Categorical Columns: ${Object.values(columnTypes).filter(t => t === 'categorical').length}</p>
            <p>Datetime Columns: ${Object.values(columnTypes).filter(t => t === 'datetime').length}</p>
        `;
        
        // Calculate missing values
        const missingValues = {};
        data.columns.forEach(column => {
            const nullCount = data.data.filter(row => row[column] === null).length;
            missingValues[column] = {
                count: nullCount,
                percentage: (nullCount / data.data.length) * 100
            };
        });
        
        // Display missing values summary
        const missingSummary = document.getElementById('missing-summary');
        missingSummary.innerHTML = '';
        const totalMissingCount = Object.values(missingValues).reduce((sum, val) => sum + val.count, 0);
        const missingColumns = Object.keys(missingValues).filter(col => missingValues[col].count > 0);
        
        missingSummary.innerHTML = `
            <p>Total Missing Values: ${totalMissingCount}</p>
            <p>Columns with Missing Values: ${missingColumns.length}</p>
        `;
        
        if (missingColumns.length > 0) {
            const missingList = document.createElement('ul');
            missingColumns.sort((a, b) => missingValues[b].count - missingValues[a].count)
                .slice(0, 5)  // Show top 5 columns with most missing values
                .forEach(column => {
                    const li = document.createElement('li');
                    li.textContent = `${column}: ${missingValues[column].count} (${missingValues[column].percentage.toFixed(2)}%)`;
                    missingList.appendChild(li);
                });
            missingSummary.appendChild(missingList);
        }
        
        // Display numeric columns summary
        const numericSummary = document.getElementById('numeric-summary');
        numericSummary.innerHTML = '';
        
        const numericColumns = Object.keys(columnTypes).filter(col => columnTypes[col] === 'numeric');
        numericColumns.forEach(column => {
            const values = data.data.map(row => parseFloat(row[column])).filter(val => !isNaN(val));
            if (values.length === 0) return;
            
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const sortedValues = [...values].sort((a, b) => a - b);
            const median = sortedValues.length % 2 === 0 
                ? (sortedValues[sortedValues.length/2 - 1] + sortedValues[sortedValues.length/2]) / 2
                : sortedValues[Math.floor(sortedValues.length/2)];
            const min = Math.min(...values);
            const max = Math.max(...values);
            const stdDev = Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${column}</td>
                <td>${mean.toFixed(2)}</td>
                <td>${median.toFixed(2)}</td>
                <td>${min.toFixed(2)}</td>
                <td>${max.toFixed(2)}</td>
                <td>${stdDev.toFixed(2)}</td>
            `;
            numericSummary.appendChild(tr);
        });
        
        if (numericColumns.length === 0) {
            numericSummary.innerHTML = '<tr><td colspan="6">No numeric columns found</td></tr>';
        }
        
        // Display categorical columns summary
        const categoricalSummary = document.getElementById('categorical-summary');
        categoricalSummary.innerHTML = '';
        
        const categoricalColumns = Object.keys(columnTypes).filter(col => columnTypes[col] === 'categorical');
        if (categoricalColumns.length > 0) {
            categoricalColumns.slice(0, 3).forEach(column => {  // Show only first 3 categorical columns
                const valueCount = {};
                data.data.forEach(row => {
                    const value = row[column] === null ? 'NULL' : row[column];
                    valueCount[value] = (valueCount[value] || 0) + 1;
                });
                
                const uniqueValues = Object.keys(valueCount).length;
                
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `<h6>${column} (${uniqueValues} unique values)</h6>`;
                
                const topValues = Object.entries(valueCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);  // Show top 5 values
                
                const ul = document.createElement('ul');
                topValues.forEach(([value, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${value}: ${count} (${((count / data.data.length) * 100).toFixed(2)}%)`;
                    ul.appendChild(li);
                });
                div.appendChild(ul);
                
                categoricalSummary.appendChild(div);
            });
        } else {
            categoricalSummary.innerHTML = '<p>No categorical columns found</p>';
        }
        
        // Show the summary
        summaryLoading.style.display = 'none';
        summaryContent.style.display = 'block';
    } catch (error) {
        console.error('Error generating data summary:', error);
        summaryLoading.style.display = 'none';
        summaryError.style.display = 'block';
        summaryError.textContent = error.message || 'Error generating data summary.';
    }
}

function applyCleaningActions() {
    // Get form values
    const form = document.getElementById('cleaning-form');
    const formData = new FormData(form);
    const cleaningActions = {};
    
    // Convert FormData to object
    for (const [key, value] of formData.entries()) {
        cleaningActions[key] = value === 'on';
    }
    
    // Show loading state
    const cleaningPlaceholder = document.getElementById('cleaning-placeholder');
    const cleaningResult = document.getElementById('cleaning-result');
    
    cleaningPlaceholder.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Applying cleaning actions...</p>
        </div>
    `;
    cleaningResult.style.display = 'none';
    
    // Send cleaning request to server
    fetch('/api/data/clean', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(cleaningActions)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to apply cleaning actions');
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Display cleaning summary
        const cleaningSummary = document.getElementById('cleaning-summary');
        cleaningSummary.innerHTML = '';
        
        if (data.summary && data.summary.length > 0) {
            data.summary.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                cleaningSummary.appendChild(li);
            });
        } else {
            cleaningSummary.innerHTML = '<li>No changes were made to the dataset</li>';
        }
        
        // Show the result
        cleaningPlaceholder.style.display = 'none';
        cleaningResult.style.display = 'block';
        
        // Reload data preview to show the cleaned data
        loadDataPreview();
    })
    .catch(error => {
        console.error('Error applying cleaning actions:', error);
        cleaningPlaceholder.innerHTML = `
            <div class="alert alert-danger">
                ${error.message || 'Error applying cleaning actions. Please try again.'}
            </div>
        `;
    });
}

function downloadCleanedData(format) {
    const url = `/api/data/download?format=${format}`;
    window.location.href = url;
}
</script>
{% endblock %} 