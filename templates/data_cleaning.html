{% extends "base.html" %}

{% block title %}Data Cleaning{% endblock %}

{% block content %}
<h1 class="main-header">Data Cleaning ðŸ§¹</h1>

<div class="bg-primary-custom">
    <h3>About Data Cleaning</h3>
    <p>Clean your dataset by handling missing values, removing duplicates, fixing data types, and more.</p>
</div>

{% if message %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="container-fluid">
    <div class="row">
        <!-- Data Preview Section -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Data Preview</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataPreview">
                            <thead>
                                <tr id="previewHeaders"></tr>
                            </thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Cleaning Actions -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Cleaning Actions</h4>
            </div>
            <div class="card-body">
                <form id="cleaning-form">
                    <div class="mb-3">
                        <h5>Missing Values</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="drop_na" name="drop_na">
                            <label class="form-check-label" for="drop_na">
                                Drop rows with missing values
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fill_na_mean" name="fill_na_mean">
                            <label class="form-check-label" for="fill_na_mean">
                                Fill numeric missing values with mean
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fill_na_mode" name="fill_na_mode">
                            <label class="form-check-label" for="fill_na_mode">
                                Fill categorical missing values with mode
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Duplicates</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="drop_duplicates" name="drop_duplicates">
                            <label class="form-check-label" for="drop_duplicates">
                                Remove duplicate rows
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Outliers</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remove_outliers" name="remove_outliers">
                            <label class="form-check-label" for="remove_outliers">
                                Remove outliers (beyond 3 standard deviations)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Data Types</h5>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convert_numeric" name="convert_numeric">
                            <label class="form-check-label" for="convert_numeric">
                                Convert likely numeric columns
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="convert_datetime" name="convert_datetime">
                            <label class="form-check-label" for="convert_datetime">
                                Convert likely datetime columns
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" id="apply-cleaning" class="btn btn-primary w-100">Apply Cleaning</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Data Summary -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Data Summary</h4>
            </div>
            <div class="card-body">
                <div id="summary-loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating data summary...</p>
                </div>
                <div id="summary-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Columns</h5>
                            <div id="column-summary" class="mb-3">
                                <!-- Column summary will be inserted here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Missing Values</h5>
                            <div id="missing-summary" class="mb-3">
                                <!-- Missing values summary will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Numeric Columns</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Mean</th>
                                    <th>Median</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Std Dev</th>
                                </tr>
                            </thead>
                            <tbody id="numeric-summary">
                                <!-- Numeric summary will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <h5>Categorical Columns</h5>
                        <div id="categorical-summary">
                            <!-- Categorical summary will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="summary-error" class="alert alert-danger" style="display: none;">
                    Error generating data summary. Please upload a file or use the sample data.
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">Cleaning Result</h4>
            </div>
            <div class="card-body">
                <div id="cleaning-result" style="display: none;">
                    <div class="mb-3">
                        <h5>Cleaning Summary</h5>
                        <ul id="cleaning-summary">
                            <!-- Cleaning summary will be inserted here -->
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h5>Download Cleaned Data</h5>
                        <button id="download-csv" class="btn btn-success me-2">Download CSV</button>
                        <button id="download-excel" class="btn btn-success">Download Excel</button>
                    </div>
                </div>
                <div id="cleaning-placeholder">
                    <p class="text-muted">Apply cleaning actions to see results.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Listen for data state updates
    document.addEventListener('dataStateUpdated', function(event) {
        const dataState = event.detail;
        updateDataPreview(dataState);
    });

    function updateDataPreview(dataState) {
        const headersContainer = document.getElementById('previewHeaders');
        const bodyContainer = document.getElementById('previewBody');
        
        // Clear existing content
        headersContainer.innerHTML = '';
        bodyContainer.innerHTML = '';

        if (!dataState || !dataState.data || dataState.data.length === 0) {
            bodyContainer.innerHTML = '<tr><td colspan="100%" class="text-center">No data loaded</td></tr>';
            return;
        }

        // Add headers
        const headers = Object.keys(dataState.data[0]);
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headersContainer.appendChild(th);
        });

        // Add data rows (limit to 100 rows for preview)
        const previewRows = dataState.data.slice(0, 100);
        previewRows.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header];
                tr.appendChild(td);
            });
            bodyContainer.appendChild(tr);
        });
    }

    // Handle apply cleaning button
    document.getElementById('apply-cleaning').addEventListener('click', applyCleaningActions);
    
    // Handle download buttons
    document.getElementById('download-csv').addEventListener('click', function() {
        downloadCleanedData('csv');
    });
    
    document.getElementById('download-excel').addEventListener('click', function() {
        downloadCleanedData('excel');
    });
});

function generateDataSummary(data) {
    const summaryLoading = document.getElementById('summary-loading');
    const summaryContent = document.getElementById('summary-content');
    const summaryError = document.getElementById('summary-error');
    
    summaryLoading.style.display = 'block';
    summaryContent.style.display = 'none';
    summaryError.style.display = 'none';
    
    try {
        // Use the data types provided by the API if available
        const columnTypes = data.dtypes || {};
        
        // If dtypes not provided, infer from preview data
        if (!data.dtypes) {
            data.columns.forEach(column => {
                // Determine column type based on first non-null value
                const nonNullValue = data.preview.find(row => row[column] !== null)?.[column];
                if (nonNullValue === undefined) {
                    columnTypes[column] = 'unknown';
                } else if (!isNaN(nonNullValue) && typeof nonNullValue !== 'boolean') {
                    columnTypes[column] = 'numeric';
                } else if (typeof nonNullValue === 'string' && 
                          (nonNullValue.match(/^\d{4}-\d{2}-\d{2}/) || 
                           nonNullValue.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/))) {
                    columnTypes[column] = 'datetime';
                } else {
                    columnTypes[column] = 'categorical';
                }
            });
        }
        
        // Count types based on dtype strings
        const numericCount = Object.values(columnTypes).filter(t => 
            t.includes('int') || t.includes('float') || t.includes('number')).length;
        const datetimeCount = Object.values(columnTypes).filter(t => 
            t.includes('date') || t.includes('time')).length;
        const categoricalCount = Object.values(columnTypes).filter(t => 
            t.includes('object') || t.includes('category') || t.includes('bool')).length;
        
        // Display column summary
        const columnSummary = document.getElementById('column-summary');
        columnSummary.innerHTML = `
            <p>Total Columns: ${data.columns.length}</p>
            <p>Numeric Columns: ${numericCount}</p>
            <p>Categorical Columns: ${categoricalCount}</p>
            <p>Datetime Columns: ${datetimeCount}</p>
        `;
        
        // Use missing values data if provided in API response
        // Otherwise, calculate from preview data (less accurate)
        let missingValues = {};
        
        if (data.missing_values) {
            missingValues = data.missing_values;
        } else {
            data.columns.forEach(column => {
                const nullCount = data.preview.filter(row => row[column] === null).length;
                missingValues[column] = {
                    count: nullCount,
                    percentage: (nullCount / data.preview.length) * 100
                };
            });
        }
        
        // Display missing values summary
        const missingSummary = document.getElementById('missing-summary');
        missingSummary.innerHTML = '';
        
        // If we have column_stats
        if (data.columns_stats) {
            const totalMissingCount = Object.values(data.columns_stats)
                .reduce((sum, col) => sum + (col.missing || 0), 0);
                
            const missingColumns = Object.keys(data.columns_stats)
                .filter(col => data.columns_stats[col].missing > 0);
            
            missingSummary.innerHTML = `
                <p>Total Missing Values: ${totalMissingCount}</p>
                <p>Columns with Missing Values: ${missingColumns.length}</p>
            `;
            
            if (missingColumns.length > 0) {
                const missingList = document.createElement('ul');
                missingColumns.sort((a, b) => data.columns_stats[b].missing - data.columns_stats[a].missing)
                    .slice(0, 5)  // Show top 5 columns with most missing values
                    .forEach(column => {
                        const stats = data.columns_stats[column];
                        const percent = ((stats.missing / data.row_count) * 100).toFixed(2);
                        const li = document.createElement('li');
                        li.textContent = `${column}: ${stats.missing} (${percent}%)`;
                        missingList.appendChild(li);
                    });
                missingSummary.appendChild(missingList);
            }
        } else {
            // Fallback if detailed stats not available
            missingSummary.innerHTML = `
                <p>Missing values information not available in preview.</p>
                <p>Please apply data cleaning to generate full statistics.</p>
            `;
        }
        
        // Display numeric columns summary
        const numericSummary = document.getElementById('numeric-summary');
        numericSummary.innerHTML = '';
        
        // Use the column stats if available from API
        if (data.columns_stats) {
            // Find numeric columns from data types
            const numericColumns = Object.keys(columnTypes).filter(col => 
                columnTypes[col].includes('int') || 
                columnTypes[col].includes('float') || 
                columnTypes[col].includes('number'));
                
            numericColumns.forEach(column => {
                if (!data.columns_stats[column]) return;
                
                const stats = data.columns_stats[column];
                if (!('mean' in stats)) return; // Skip if not numeric stats
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${column}</td>
                    <td>${stats.mean !== null ? stats.mean.toFixed(2) : 'N/A'}</td>
                    <td>${stats.median !== null ? stats.median.toFixed(2) : 'N/A'}</td>
                    <td>${stats.min !== null ? stats.min.toFixed(2) : 'N/A'}</td>
                    <td>${stats.max !== null ? stats.max.toFixed(2) : 'N/A'}</td>
                    <td>${stats.std !== null ? stats.std.toFixed(2) : 'N/A'}</td>
                `;
                numericSummary.appendChild(tr);
            });
            
            if (numericColumns.length === 0) {
                numericSummary.innerHTML = '<tr><td colspan="6">No numeric columns found</td></tr>';
            }
        } else {
            // Simplified fallback using preview data
            const numericColumns = Object.keys(columnTypes).filter(col => 
                columnTypes[col].includes('int') || 
                columnTypes[col].includes('float') || 
                columnTypes[col].includes('number'));
                
            if (numericColumns.length === 0) {
                numericSummary.innerHTML = '<tr><td colspan="6">No numeric columns found in preview</td></tr>';
            } else {
                numericSummary.innerHTML = '<tr><td colspan="6">Full numeric statistics will be available after data cleaning</td></tr>';
            }
        }
        
        // Display categorical columns summary - simplified for preview
        const categoricalSummary = document.getElementById('categorical-summary');
        categoricalSummary.innerHTML = '';
        
        // Find categorical columns from data types
        const categoricalColumns = Object.keys(columnTypes).filter(col => 
            columnTypes[col].includes('object') || 
            columnTypes[col].includes('category') || 
            columnTypes[col].includes('bool'));
            
        if (categoricalColumns.length > 0) {
            if (data.columns_stats) {
                categoricalColumns.slice(0, 3).forEach(column => {  // Show only first 3 categorical columns
                    const stats = data.columns_stats[column];
                    if (!stats) return;
                    
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `<h6>${column} (${stats.unique_values || '?'} unique values)</h6>`;
                    
                    // If we had top value frequencies, we could show them here
                    
                    categoricalSummary.appendChild(div);
                });
            } else {
                categoricalSummary.innerHTML = '<p>Categorical column details will be available after data cleaning</p>';
            }
        } else {
            categoricalSummary.innerHTML = '<p>No categorical columns found</p>';
        }
        
        // Show the summary
        summaryLoading.style.display = 'none';
        summaryContent.style.display = 'block';
    } catch (error) {
        console.error('Error generating data summary:', error);
        summaryLoading.style.display = 'none';
        summaryError.style.display = 'block';
        summaryError.textContent = error.message || 'Error generating data summary.';
    }
}

function applyCleaningActions() {
    // Get form values
    const form = document.getElementById('cleaning-form');
    const formData = new FormData(form);
    const cleaningActions = {};
    
    // Convert FormData to object
    for (const [key, value] of formData.entries()) {
        cleaningActions[key] = value === 'on';
    }
    
    // Show loading state
    const cleaningPlaceholder = document.getElementById('cleaning-placeholder');
    const cleaningResult = document.getElementById('cleaning-result');
    
    cleaningPlaceholder.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Applying cleaning actions...</p>
        </div>
    `;
    cleaningResult.style.display = 'none';
    
    // Make API request to clean data
    fetch('/api/clean_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(cleaningActions),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to apply cleaning actions');
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Display cleaning summary
        const cleaningSummary = document.getElementById('cleaning-summary');
        cleaningSummary.innerHTML = '';
        
        if (data.summary && data.summary.length > 0) {
            data.summary.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                cleaningSummary.appendChild(li);
            });
        } else {
            cleaningSummary.innerHTML = '<li>No changes were made to the dataset</li>';
        }
        
        // Show the result
        cleaningPlaceholder.style.display = 'none';
        cleaningResult.style.display = 'block';
        
        // Reload data preview to show the cleaned data
        updateDataPreview(data);
    })
    .catch(error => {
        console.error('Error applying cleaning actions:', error);
        cleaningPlaceholder.innerHTML = `
            <div class="alert alert-danger">
                ${error.message || 'Error applying cleaning actions. Please try again.'}
            </div>
        `;
    });
}

function downloadCleanedData(format) {
    const url = `/api/download_data?format=${format}`;
    window.location.href = url;
}
</script>
{% endblock %} 