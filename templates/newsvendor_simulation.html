{% extends "base.html" %}

{% block title %}NewsVendor Simulation{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4">NewsVendor Simulation ðŸ“°</h1>

<div class="simulation-card">
    <h3>NewsVendor Model Simulator</h3>
    <p>Experiment with different order quantities and see how they perform against the optimal strategy.</p>
</div>

<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h4 class="mb-0">How to Use</h4>
    </div>
    <div class="card-body">
        <p>The NewsVendor model helps determine the optimal order quantity for products with uncertain demand. This simulator allows you to:</p>
        <ol>
            <li>Set parameters like demand distribution, costs, and prices</li>
            <li>View the optimal order quantity calculation</li>
            <li>Experiment with your own order quantities to see profit outcomes</li>
            <li>Visualize demand distributions and critical ratios</li>
        </ol>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Parameters</h5>
            </div>
            <div class="card-body">
                <form id="newsvendorForm">
                    <div class="mb-3">
                        <label for="distribution" class="form-label">Demand Distribution</label>
                        <select class="form-select" id="distribution" name="distribution">
                            <option value="Normal">Normal</option>
                            <option value="Uniform">Uniform</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expected_demand" class="form-label">Expected Demand</label>
                        <input type="number" class="form-control" id="expected_demand" name="expected_demand" min="1" value="100">
                    </div>
                    
                    <div class="mb-3">
                        <label for="std_dev" class="form-label">Standard Deviation</label>
                        <input type="number" class="form-control" id="std_dev" name="std_dev" min="0.1" step="0.1" value="10.0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="cost" class="form-label">Cost Per Unit</label>
                        <input type="number" class="form-control" id="cost" name="cost" min="0.1" step="0.1" value="5.0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="price" class="form-label">Selling Price</label>
                        <input type="number" class="form-control" id="price" name="price" min="0.1" step="0.1" value="10.0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="salvage_price" class="form-label">Salvage Value</label>
                        <input type="number" class="form-control" id="salvage_price" name="salvage_price" min="0" step="0.1" value="2.5">
                    </div>
                    
                    <button type="button" id="calculateBtn" class="btn btn-primary w-100">Calculate Optimal Order</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Optimal Order Quantity</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Optimal Order Quantity</h6>
                            <h3 id="optimal-q">-</h3>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Critical Ratio</h6>
                            <span id="critical-ratio">-</span>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Service Level</h6>
                            <span id="service-level">-</span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6>Expected Profit</h6>
                            <span id="expected-profit">-</span>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Expected Sales</h6>
                            <span id="expected-sales">-</span>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Expected Salvage</h6>
                            <span id="expected-salvage">-</span>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Total Cost</h6>
                            <span id="total-cost">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Demand Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="distribution-chart" height="200"></canvas>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Try Your Own Order Quantity</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-8">
                        <input type="range" class="form-range" id="order-slider" min="50" max="150" step="1" value="100">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <input type="number" class="form-control" id="order-quantity" value="100">
                            <span class="input-group-text">units</span>
                        </div>
                    </div>
                </div>
                
                <button type="button" id="simulateBtn" class="btn btn-warning">Simulate</button>
                
                <div class="mt-3" id="simulation-results" style="display: none;">
                    <h6>Simulation Results (100 periods):</h6>
                    <div class="mb-2">Your Order: <span id="your-order">-</span> units</div>
                    <div class="mb-2">Your Profit: $<span id="your-profit">-</span></div>
                    <div class="mb-2">Optimal Profit: $<span id="optimal-profit">-</span></div>
                    <div class="mb-2">Profit Difference: $<span id="profit-diff">-</span></div>
                    <div class="alert" id="profit-alert"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let distributionChart = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Connect form controls
    document.getElementById('calculateBtn').addEventListener('click', calculateOptimalOrder);
    document.getElementById('simulateBtn').addEventListener('click', simulateOrder);
    
    // Link slider and input
    const orderSlider = document.getElementById('order-slider');
    const orderQuantity = document.getElementById('order-quantity');
    
    orderSlider.addEventListener('input', function() {
        orderQuantity.value = this.value;
    });
    
    orderQuantity.addEventListener('input', function() {
        orderSlider.value = this.value;
    });
    
    // Initial calculation
    calculateOptimalOrder();
});

function calculateOptimalOrder() {
    // Get form values
    const distribution = document.getElementById('distribution').value;
    const expectedDemand = parseFloat(document.getElementById('expected_demand').value);
    const stdDev = parseFloat(document.getElementById('std_dev').value);
    const cost = parseFloat(document.getElementById('cost').value);
    const price = parseFloat(document.getElementById('price').value);
    const salvagePrice = parseFloat(document.getElementById('salvage_price').value);
    
    // Calculate newsvendor metrics
    const criticalRatio = (price - cost) / (price - salvagePrice);
    let optimalQ;
    
    if (distribution === 'Normal') {
        // Normal distribution - using approximation
        const z = normInv(criticalRatio);
        optimalQ = expectedDemand + stdDev * z;
    } else {
        // Uniform distribution
        const a = expectedDemand - stdDev * Math.sqrt(3);  // Lower bound
        const b = expectedDemand + stdDev * Math.sqrt(3);  // Upper bound
        optimalQ = a + (b - a) * criticalRatio;
    }
    
    // Calculate expected metrics
    const expectedSales = price * expectedDemand;
    const expectedExcess = Math.max(0, optimalQ - expectedDemand);
    const salvageRevenue = salvagePrice * expectedExcess;
    const totalCost = cost * optimalQ;
    const expectedProfit = expectedSales + salvageRevenue - totalCost;
    
    // Update display
    document.getElementById('optimal-q').textContent = optimalQ.toFixed(2);
    document.getElementById('critical-ratio').textContent = criticalRatio.toFixed(2);
    document.getElementById('service-level').textContent = (criticalRatio * 100).toFixed(2) + '%';
    document.getElementById('expected-profit').textContent = '$' + expectedProfit.toFixed(2);
    document.getElementById('expected-sales').textContent = '$' + expectedSales.toFixed(2);
    document.getElementById('expected-salvage').textContent = '$' + salvageRevenue.toFixed(2);
    document.getElementById('total-cost').textContent = '$' + totalCost.toFixed(2);
    
    // Update slider range
    const orderSlider = document.getElementById('order-slider');
    orderSlider.min = Math.max(1, Math.floor(expectedDemand - 3 * stdDev));
    orderSlider.max = Math.ceil(expectedDemand + 3 * stdDev);
    
    // Display distribution
    updateDistributionChart(expectedDemand, stdDev, optimalQ, distribution);
}

function simulateOrder() {
    // Get parameters
    const distribution = document.getElementById('distribution').value;
    const expectedDemand = parseFloat(document.getElementById('expected_demand').value);
    const stdDev = parseFloat(document.getElementById('std_dev').value);
    const cost = parseFloat(document.getElementById('cost').value);
    const price = parseFloat(document.getElementById('price').value);
    const salvagePrice = parseFloat(document.getElementById('salvage_price').value);
    const orderQuantity = parseFloat(document.getElementById('order-quantity').value);
    
    // Find optimal order again
    const criticalRatio = (price - cost) / (price - salvagePrice);
    let optimalQ;
    
    if (distribution === 'Normal') {
        const z = normInv(criticalRatio);
        optimalQ = expectedDemand + stdDev * z;
    } else {
        const a = expectedDemand - stdDev * Math.sqrt(3);
        const b = expectedDemand + stdDev * Math.sqrt(3);
        optimalQ = a + (b - a) * criticalRatio;
    }
    
    // Run simulation
    const periods = 100;
    const yourProfit = simulateNewsvendor(periods, orderQuantity, expectedDemand, stdDev, price, cost, salvagePrice, distribution);
    const optimalProfit = simulateNewsvendor(periods, optimalQ, expectedDemand, stdDev, price, cost, salvagePrice, distribution);
    const profitDiff = optimalProfit - yourProfit;
    
    // Show results
    document.getElementById('simulation-results').style.display = 'block';
    document.getElementById('your-order').textContent = orderQuantity.toFixed(2);
    document.getElementById('your-profit').textContent = yourProfit.toFixed(2);
    document.getElementById('optimal-profit').textContent = optimalProfit.toFixed(2);
    document.getElementById('profit-diff').textContent = profitDiff.toFixed(2);
    
    // Add feedback
    const profitAlert = document.getElementById('profit-alert');
    if (profitDiff <= 0) {
        profitAlert.className = 'alert alert-success';
        profitAlert.textContent = 'Great job! Your order quantity is performing optimally!';
    } else if (profitDiff < optimalProfit * 0.05) {
        profitAlert.className = 'alert alert-info';
        profitAlert.textContent = 'Close! Your order is within 5% of optimal performance.';
    } else if (profitDiff < optimalProfit * 0.1) {
        profitAlert.className = 'alert alert-warning';
        profitAlert.textContent = 'Your order is within 10% of optimal performance. Keep adjusting!';
    } else {
        profitAlert.className = 'alert alert-danger';
        profitAlert.textContent = 'Your order is far from optimal. Try moving closer to the optimal quantity.';
    }
}

function simulateNewsvendor(periods, orderQuantity, demandMean, demandStd, price, cost, salvage, distribution) {
    let totalProfit = 0;
    
    // Generate pseudo-random number sequence
    const demands = [];
    for (let i = 0; i < periods; i++) {
        let demand;
        if (distribution === 'Normal') {
            demand = randomNormal(demandMean, demandStd);
        } else {
            const a = demandMean - demandStd * Math.sqrt(3);
            const b = demandMean + demandStd * Math.sqrt(3);
            demand = randomUniform(a, b);
        }
        demands.push(demand);
    }
    
    // Calculate profit
    for (const demand of demands) {
        const sales = Math.min(demand, orderQuantity);
        const leftover = Math.max(0, orderQuantity - demand);
        
        const revenue = sales * price;
        const salvageRevenue = leftover * salvage;
        const orderingCost = orderQuantity * cost;
        
        const profit = revenue + salvageRevenue - orderingCost;
        totalProfit += profit;
    }
    
    return totalProfit;
}

function updateDistributionChart(mean, std, optimalQ, distribution) {
    const ctx = document.getElementById('distribution-chart').getContext('2d');
    
    // Clear previous chart
    if (distributionChart) {
        distributionChart.destroy();
    }
    
    // Generate distribution data
    const dataPoints = 100;
    let xValues, yValues;
    let xMin, xMax;
    
    if (distribution === 'Normal') {
        xMin = mean - 4 * std;
        xMax = mean + 4 * std;
        xValues = Array.from({length: dataPoints}, (_, i) => xMin + (xMax - xMin) * i / (dataPoints - 1));
        yValues = xValues.map(x => normalPdf(x, mean, std));
    } else {
        const a = mean - std * Math.sqrt(3);
        const b = mean + std * Math.sqrt(3);
        xMin = a - (b - a) * 0.1;
        xMax = b + (b - a) * 0.1;
        xValues = Array.from({length: dataPoints}, (_, i) => xMin + (xMax - xMin) * i / (dataPoints - 1));
        yValues = xValues.map(x => (x >= a && x <= b) ? 1 / (b - a) : 0);
    }
    
    // Find optimal Q index
    const optimalIndex = xValues.findIndex(x => x >= optimalQ);
    
    // Create left and right datasets
    const leftX = xValues.slice(0, optimalIndex);
    const leftY = yValues.slice(0, optimalIndex);
    const rightX = xValues.slice(optimalIndex);
    const rightY = yValues.slice(optimalIndex);
    
    // Create the chart
    distributionChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Stockout Risk',
                    data: leftX.map((x, i) => ({ x, y: leftY[i] })),
                    borderColor: 'rgba(255, 0, 0, 1)',
                    backgroundColor: 'rgba(255, 0, 0, 0.3)',
                    fill: 'origin'
                },
                {
                    label: 'Overage Risk',
                    data: rightX.map((x, i) => ({ x, y: rightY[i] })),
                    borderColor: 'rgba(0, 0, 255, 1)',
                    backgroundColor: 'rgba(0, 0, 255, 0.3)',
                    fill: 'origin'
                },
                {
                    label: 'Optimal Q',
                    data: [{ x: optimalQ, y: 0 }, { x: optimalQ, y: Math.max(...yValues) }],
                    borderColor: 'rgba(0, 128, 0, 1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Demand'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Probability Density'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

// Helper functions
function normalPdf(x, mean, std) {
    const variance = std * std;
    return Math.exp(-Math.pow(x - mean, 2) / (2 * variance)) / (Math.sqrt(2 * Math.PI * variance));
}

function normInv(p) {
    // Approximation of the normal inverse CDF
    if (p <= 0) return -Infinity;
    if (p >= 1) return Infinity;
    
    // Coefficients for the approximation
    const a1 = -3.969683028665376e+01;
    const a2 = 2.209460984245205e+02;
    const a3 = -2.759285104469687e+02;
    const a4 = 1.383577518672690e+02;
    const a5 = -3.066479806614716e+01;
    const a6 = 2.506628277459239e+00;
    
    const b1 = -5.447609879822406e+01;
    const b2 = 1.615858368580409e+02;
    const b3 = -1.556989798598866e+02;
    const b4 = 6.680131188771972e+01;
    const b5 = -1.328068155288572e+01;
    
    const c1 = -7.784894002430293e-03;
    const c2 = -3.223964580411365e-01;
    const c3 = -2.400758277161838e+00;
    const c4 = -2.549732539343734e+00;
    const c5 = 4.374664141464968e+00;
    const c6 = 2.938163982698783e+00;
    
    const d1 = 7.784695709041462e-03;
    const d2 = 3.224671290700398e-01;
    const d3 = 2.445134137142996e+00;
    const d4 = 3.754408661907416e+00;
    
    let q, r;
    if (p < 0.5) {
        q = p;
    } else {
        q = 1 - p;
    }
    
    if (q > 0.02425) {
        // Central region
        r = q - 0.5;
        r = r * r;
        return (p > 0.5 ? 1 : -1) * (((((a6 * r + a5) * r + a4) * r + a3) * r + a2) * r + a1) /
                                    (((((b5 * r + b4) * r + b3) * r + b2) * r + b1) * r + 1);
    } else {
        // Tail region
        r = Math.sqrt(-Math.log(q));
        const result = (((((c6 * r + c5) * r + c4) * r + c3) * r + c2) * r + c1) /
                       ((((d4 * r + d3) * r + d2) * r + d1) * r + 1);
        return p > 0.5 ? -result : result;
    }
}

function randomNormal(mean, stdDev) {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    return mean + z * stdDev;
}

function randomUniform(min, max) {
    return min + Math.random() * (max - min);
}
</script>
{% endblock %} 